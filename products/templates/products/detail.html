{% extends 'base.html' %}

{% block content %}
{% load staticfiles %}
<div class="row">
    <div class="col-1">
        <a href="{{ product.url }}">
            <img src="{{ product.icon.url }}" height=80 width=80 class="img-fluid" />
        </a>

    </div>
    <div class="col-2">
        <a href="{{ product.url }}">
            <h1>{{ product.title }}</h1>
        </a>
    </div>
</div>
<br />

<div class="row">
    <div class="col-8 text-center">
        <img src="{{ product.image.url }}" height=600 width=600 class="img-fluid" />
    </div>
    {% if upvote == False %}
    <div class="col-4">
        <a href="javascript:{document.getElementById('upvote').submit()}">
            <button class="btn btn-primary btn-lg btn-block">
                <img src="{% static 'arrow.png' %}" height=20 width=20 /> &nbsp;&nbsp; Upvote {{ product.votes_total }}
            </button>
        </a>
    </div>
    {% else %}
    <div class="col-4">
        <a href="javascript:{document.getElementById('deupvote').submit()}">
            <button class="btn btn-secondary btn-lg btn-block">
                <img src="{% static 'arrow.png' %}" height=20 width=20 /> &nbsp;&nbsp; Upvote {{ product.votes_total }}
            </button>
        </a>
    </div>
    {% endif %}
</div>
<br />

<div class="row">
    <div class="col-4">
        <h4>Hunted by {{ product.hunter.username }}</h4>
    </div>
    <div class="col-4 text-end">
        <h4><img src="{% static 'calendar.jpg' %}" height=20 width=20 />&nbsp;&nbsp;{{ product.pub_date_pretty }}</h4>
    </div>
</div>

<br />

<div class="row">
    <div class="col-8">
        <p>{{ product.body }}</cp>
    </div>
</div>

<form id="upvote" method="POST" action="{% url 'upvote' product.id %}">
    {% csrf_token%}
    <input type="hidden">
</form>

<form id="deupvote" method="POST" action="{% url 'deupvote' product.id %}">
    {% csrf_token%}
    <input type="hidden">
</form>


{% if user.is_authenticated and user.username == product.hunter.username %}
<div class="row">
    <div class="col-8 text-end">
        <a href="javascript:{document.getElementById('edit').submit()}">
            <button class="btn btn-light btn-lg btn-block">
                <img src="{% static 'pencil.png' %}" height=20 width=20 /> &nbsp;&nbsp; Edit
            </button>
        </a>
    </div>

    <form id="edit" action="{% url 'edit' product.id %}">
        {% csrf_token%}
        <input type="hidden">
    </form>
</div>
{% endif %}

<div class="row">
    <h5>Reviews</h5>
    <form method="POST" action="{% url 'review' product.id %}">
        {% csrf_token%}

        <div class="col-8">
            <textarea type="textbox" class="form-control" rows="3" name="body"
                placeholder="Write your review"></textarea>
        </div>

        <div class="col-8 text-end">
            <button type="submit" class="btn btn-light"> Submit </button>
        </div>
    </form>
</div>
<br />

{% for review, numlikes, liked, disliked in reviewsbundle %}
<div class="row">
    <div class="col-8 border">
        <p>
            <img src="{% static 'user.png' %}" height=20 width=20 /> {{ review.reviewer }}
        </p>
        <p>{{ review.body }}</p>
        <p class="text-end">
            <a href="" url="{% url 'unlike' product.id review.id %}" id="unlike{{ review.id }}" class="unlike" hidden>
                <img src="{% static 'liked.png' %}" height=20 width=20 />
            </a>

            <a href="" url="{% url 'like' product.id review.id %}" id="like{{ review.id }}" class="like">
                <img src="{% static 'like.png' %}" height=20 width=20 />
            </a>


            &nbsp; <span id="numlikes{{ review.id }}">{{ numlikes }}</span> &nbsp;


            <a href="" url="{% url 'undislike' product.id review.id %}" id="undislike{{ review.id }}" class="undislike" hidden>
                <img src="{% static 'disliked.png' %}" height=20 width=20 />
            </a>

            <a href="" url="{% url 'dislike' product.id review.id %}" id="dislike{{ review.id }}" class="dislike">
                <img src="{% static 'dislike.png' %}" height=20 width=20 />
            </a>
        </p>
    </div>
</div>
<br />



{% endfor %}
{% endblock %}

{% block javascript %}
<script>
    jQuery(function ($) {
        

        $('.like').click(function (e) {
            e.preventDefault();
            const curID = e.currentTarget.id;
            const numID =curID.replace('like', 'numlikes');
            const nextID = curID.replace('like', 'unlike');
            let numlikes = Number(document.getElementById(numID).textContent);

            $.ajax({
                type: "POST",
                url: $(this).attr("url"),
                data: { csrfmiddlewaretoken: window.CSRF_TOKEN },
                success: function (data) {
                    numlikes += data['like_increment'];
                    document.getElementById(numID).innerText = numlikes;
                    document.getElementById(curID).hidden = true;
                    document.getElementById(nextID).hidden = false;

                    if(data['like_increment']===2) {
                        let ID = curID.replace('like', 'undislike');
                        document.getElementById(ID).hidden = true;
                        ID = curID.replace('like', 'dislike');
                        document.getElementById(ID).hidden = false;
                    }
                },
                error: function () {
                    window.location.href = "/accounts/signup"
                },
            });
        });

        $('.unlike').click(function (e) {
            e.preventDefault();
            const curID = e.currentTarget.id;
            const numID =curID.replace('unlike', 'numlikes');
            const nextID = curID.replace('unlike', 'like');
            let numlikes = Number(document.getElementById(numID).textContent);

            $.ajax({
                type: "POST",
                url: $(this).attr("url"),
                data: { csrfmiddlewaretoken: window.CSRF_TOKEN },
                success: function (data) {
                    numlikes -= data['like_decrement'];
                    document.getElementById(numID).innerText = numlikes;
                    document.getElementById(curID).hidden = true;
                    document.getElementById(nextID).hidden = false;
                },
                error: function () {
                    window.location.href = "/accounts/signup"
                },
            });
        });

        $('.dislike').click(function (e) {
            e.preventDefault();
            const curID = e.currentTarget.id;
            const numID =curID.replace('dislike', 'numlikes');
            const nextID = curID.replace('dislike', 'undislike');
            let numlikes = Number(document.getElementById(numID).textContent);

            $.ajax({
                type: "POST",
                url: $(this).attr("url"),
                data: { csrfmiddlewaretoken: window.CSRF_TOKEN },
                success: function (data) {
                    numlikes -= data['like_decrement'];
                    document.getElementById(numID).innerText = numlikes;
                    document.getElementById(curID).hidden = true;
                    document.getElementById(nextID).hidden = false;

                    if(data['like_decrement']===2) {
                        let ID = curID.replace('dislike', 'unlike');
                        document.getElementById(ID).hidden = true;
                        ID = curID.replace('dislike', 'like');
                        document.getElementById(ID).hidden = false;
                    }
                },
                error: function () {
                    window.location.href = "/accounts/signup"
                },
            });
        });

        $('.undislike').click(function (e) {
            e.preventDefault();
            const curID = e.currentTarget.id;
            const numID =curID.replace('undislike', 'numlikes');
            const nextID = curID.replace('undislike', 'dislike');
            let numlikes = Number(document.getElementById(numID).textContent);

            $.ajax({
                type: "POST",
                url: $(this).attr("url"),
                data: { csrfmiddlewaretoken: window.CSRF_TOKEN },
                success: function (data) {
                    numlikes += data['like_increment'];
                    document.getElementById(numID).innerText = numlikes;
                    document.getElementById(curID).hidden = true;
                    document.getElementById(nextID).hidden = false;
                },
                error: function () {
                    window.location.href = "/accounts/signup"
                },
            });
        });
    });
</script>

{% endblock %}